(function () {
'use strict';

var STORAGE_KEYS={SECTION:'lpDtm-section',TAGLET_SECTION:'lpDtm-tagletSection',TOPIC:'lpDtm-topic',BROWSER_SUPPORT:'lpDtm-browserSupport'};function setStorageItem(a,b){var c=2<arguments.length&&arguments[2]!==void 0&&arguments[2];try{!0===c?window.sessionStorage.setItem(a,b):window.localStorage.setItem(a,b);}catch(a){}}function getStorageItem(a){var b=1<arguments.length&&arguments[1]!==void 0&&arguments[1];try{return!0===b?window.sessionStorage.getItem(a):window.localStorage.getItem(a)}catch(a){}}

var classCallCheck = function (instance, Constructor) {
  if (!(instance instanceof Constructor)) {
    throw new TypeError("Cannot call a class as a function");
  }
};

var createClass = function () {
  function defineProperties(target, props) {
    for (var i = 0; i < props.length; i++) {
      var descriptor = props[i];
      descriptor.enumerable = descriptor.enumerable || false;
      descriptor.configurable = true;
      if ("value" in descriptor) descriptor.writable = true;
      Object.defineProperty(target, descriptor.key, descriptor);
    }
  }

  return function (Constructor, protoProps, staticProps) {
    if (protoProps) defineProperties(Constructor.prototype, protoProps);
    if (staticProps) defineProperties(Constructor, staticProps);
    return Constructor;
  };
}();

var BrowserSupport=function(){function a(b){var c=1<arguments.length&&void 0!==arguments[1]&&arguments[1];classCallCheck(this,a), this.timeout=5e3, this.pingDuration=1e3, this.pingCount=0, this.cb=b, this.isBrowserSupported=void 0, this.useSessionState=c, this.init();}return createClass(a,[{key:'init',value:function init(){this.isBrowserSupported=this.getStoredBrowserSupport(), void 0===this.isBrowserSupported||!1===this.useSessionState?window.lpTag.events.bind({appName:'LPTAG',eventName:'ON_STARTED',triggerOnce:!0,func:this.checkEmbeddedSupported.bind(this)}):this.cb(this.isBrowserSupported);}},{key:'checkEmbeddedSupported',value:function checkEmbeddedSupported(){if(window.lpTag.taglets&&window.lpTag.taglets.lpUnifiedWindow&&window.lpTag.taglets.lpUnifiedWindow.inspect().conf&&window.lpTag.taglets.lpUnifiedWindow.inspect().conf.embeddedSupported){this.isBrowserSupported=window.lpTag.taglets.lpUnifiedWindow.inspect().conf.embeddedSupported, this.cb(this.isBrowserSupported), this.setStoredBrowserSupport();var a=this.isBrowserSupported?'embeddedsupported':'embeddedNotSupported',b={type:'service',service:{topic:a,status:0}};window.lpTag.sdes.send?window.lpTag.sdes.send(b):window.lpTag.sdes.push(b);}else this.pingCount++, this.pingDuration*this.pingCount>=this.pingTimeout?(this.isBrowserSupported=!1, this.cb(this.isBrowserSupported)):setTimeout(this.checkEmbeddedSupported.bind(this),this.pingDuration);}},{key:'setStoredBrowserSupport',value:function setStoredBrowserSupport(){setStorageItem(STORAGE_KEYS.BROWSER_SUPPORT,this.isBrowserSupported,!0);}},{key:'getStoredBrowserSupport',value:function getStoredBrowserSupport(){var a=getStorageItem(STORAGE_KEYS.BROWSER_SUPPORT,!0);if(a)try{var b=JSON.parse(a);return!0===b||!1===b?b:void 0}catch(a){}}}]), a}();

var query={query:'\n    {\n      me {\n        profileID\n      }\n    }\n'}; var LivePerson=function(){function a(b,c,d,e){classCallCheck(this,a), this.dom=b, this.auth=c, this.global=d, this.config=e, this.engagementId=0, this.browserSupport=void 0, this.browserSupportCb, this.hasLoaded=!1, this.init();}return createClass(a,[{key:'init',value:function init(){this.dom.loadLivepersonScript(), this.browserSupport=new BrowserSupport(this.onBrowserSupportDetermined.bind(this)), this.exposePageEvents(), this.initLivePerson(), this.identities(), this.initSkyBotWebAssistant(), window.addEventListener('visibilitychange',function(){if(!document.hidden){var a=document.getElementById(window.lpTag.taglets.lpUnifiedWindow.inspect().conf.wrapperElementId),b=a&&a.getElementsByTagName('TEXTAREA')[0];b&&b.focus();}});}},{key:'identities',value:function identities(){this.auth.getAuthToken()&&window.fetch(this.config.skyportUrl,{method:'POST',headers:{"x-api-token":'7c6e1020-d36b-0139-b7dd-624adf4e86a6',Authorization:'Bearer '+this.auth.getAuthToken(),"Content-Type":'application/json'},body:JSON.stringify(query)}).then(function(a){if(a.ok)return a.json()}).then(function(a){var b=a&&a.data&&a.data.me&&a.data.me.profileID;b&&(window.lpTag.identities=[], window.lpTag.identities.push(function(a){return a({iss:'Sky',acr:'loa1',sub:b})}));}).catch(function(){});}},{key:'initLivePerson',value:function initLivePerson(a){'loading'===document.readyState?document.addEventListener('DOMContentLoaded',this.setupDom.bind(this)):this.setupDom(), this.bindEngagmentId(), this.auth.setLivePersonAuthCallback(), this.exposeChatOpeningEvent(), this.hasLoaded=!0, a&&a();}},{key:'onBrowserSupportDetermined',value:function onBrowserSupportDetermined(a){this.global.browser={supported:a}, this.isBrowserSupported=a, this.browserSupportCb&&a&&this.browserSupportCb();}},{key:'setupDom',value:function setupDom(){this.isBrowserSupported?this.dom.loadPageElements():this.browserSupportCb=this.dom.loadPageElements.bind(this.dom);}},{key:'bindEngagmentId',value:function bindEngagmentId(){var a=this;window.lpTag.events.bind('LP_OFFERS','OFFER_IMPRESSION',function(b){a.engagementId=b.engagementId, a.global.engagementId=a.engagementId;});}},{key:'exposeChatOpeningEvent',value:function exposeChatOpeningEvent(){this.global.openLivePersonChat=function(a){var b=this;a&&!0===a.showChatSurvey&&window.sky&&window.sky.chat?(window.sky.chat.config.set('category',a.preChatCategory||'SAL_Retention'), window.sky.chat.session.create(null,{isWebMessenger:!0},function(){b.openLivePersonChat();})):window.lpTag.taglets.rendererStub.click(this.engagementId);};}},{key:'exposePageEvents',value:function exposePageEvents(){var a=this;this.global.onPageChanged||(this.global.onPageChanged=function(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:window.location.href,c=arguments[1];setStorageItem(STORAGE_KEYS.SECTION,c.section), setStorageItem(STORAGE_KEYS.TAGLET_SECTION,c.tagletSection), setStorageItem(STORAGE_KEYS.TOPIC,c.topic), !0===a.hasLoaded?window.lpTag.newPage(b,c):a.initLivePerson(function(){window.lpTag.newPage(b,c);});});}},{key:'initSkyBotWebAssistant',value:function initSkyBotWebAssistant(){var a=localStorage.getItem('skybot:livePersonActive');a&&new Date().getTime()>new Date(new Date(a).getTime()+172800000).getTime()&&localStorage.removeItem('skybot:livePersonActive'), window.addEventListener('load',function(){window.lpTag.events.bind({eventName:'state',appName:'lpUnifiedWindow',func:function func(a){'init'===a.state?document.querySelector('#sky-web-assistant-container')&&window._hideSkyBotWebAssistant():'chatting'===a.state?localStorage.setItem('skybot:livePersonActive',new Date().toISOString()):'ended'===a.state&&localStorage.removeItem('skybot:livePersonActive');},async:!1});});}}]), a}();

var DomHelper=function(){function a(){classCallCheck(this,a);}return createClass(a,[{key:'loadPageElements',value:function loadPageElements(){if(!document.getElementById('lpSkyMessagingButton')){var a=document.createElement('div');a.id='lpSkyMessagingButton', a.classList.add('hide'), document.body.appendChild(a);}}},{key:'loadLivepersonScript',value:function loadLivepersonScript(){window.lpTag=window.lpTag||{}, window.lpTag.section=window.livepersonDefaultSection||'section', window.lpTag.tagletSection=window.livepersonDefaultTagletSection||'tagletSection', window.lpTag=window.lpTag||{}, 'undefined'==typeof window.lpTag._tagCount?(window.lpTag={wl:lpTag.wl||null,scp:lpTag.scp||null,site:'36478212',section:lpTag.section||'',tagletSection:lpTag.tagletSection||null,autoStart:!1!==lpTag.autoStart,ovr:lpTag.ovr||{},_v:'1.10.0',_tagCount:1,protocol:'https:',events:{bind:function bind(a,b,c){lpTag.defer(function(){lpTag.events.bind(a,b,c);},0);},trigger:function trigger(a,b,c){lpTag.defer(function(){lpTag.events.trigger(a,b,c);},1);}},defer:function defer(a,b){0===b?(this._defB=this._defB||[], this._defB.push(a)):1===b?(this._defT=this._defT||[], this._defT.push(a)):(this._defL=this._defL||[], this._defL.push(a));},load:function load(a,b,c){var d=this;setTimeout(function(){d._load(a,b,c);},0);},_load:function _load(a,b,c){var d=a;a||(d=this.protocol+'//'+(this.ovr&&this.ovr.domain?this.ovr.domain:'lptag.liveperson.net')+'/tag/tag.js?site='+this.site);var e=document.createElement('script');e.setAttribute('charset',b?b:'UTF-8'), c&&e.setAttribute('id',c), e.setAttribute('src',d), document.getElementsByTagName('head').item(0).appendChild(e);},init:function init(){this._timing=this._timing||{}, this._timing.start=new Date().getTime();var a=this;window.attachEvent?window.attachEvent('onload',function(){a._domReady('domReady');}):(window.addEventListener('DOMContentLoaded',function(){a._domReady('contReady');},!1), window.addEventListener('load',function(){a._domReady('domReady');},!1)), 'undefined'==typeof window._lptStop&&this.load();},start:function start(){this.autoStart=!0;},_domReady:function _domReady(a){this.isDom||(this.isDom=!0, this.events.trigger('LPT','DOM_READY',{t:a})), this._timing[a]=new Date().getTime();},vars:lpTag.vars||[],dbs:lpTag.dbs||[],ctn:lpTag.ctn||[],sdes:lpTag.sdes||[],hooks:lpTag.hooks||[],identities:lpTag.identities||[],ev:lpTag.ev||[]}, lpTag.init()):window.lpTag._tagCount+=1;}}]), a}();

var Auth=function(){function a(b,c){classCallCheck(this,a), this.authServiceUrl=c.authenticatorEndpoint+'/messaging/ssotoken/', this.cookies=b;}return createClass(a,[{key:'setLivePersonAuthCallback',value:function setLivePersonAuthCallback(){window.lpGetAuthenticationToken=function(a){this.getAuthToken()||a(null,'No token');var b=getStorageItem(STORAGE_KEYS.TOPIC)||'TV';window.fetch(this.authServiceUrl+b,{headers:{skySSOToken:this.getAuthToken()}}).then(function(a){if(a.ok)return a.json()}).then(function(b){a(b.token);}).catch(function(b){a(null,b);});}.bind(this);}},{key:'getAuthToken',value:function getAuthToken(){return this.cookies.getCookie('skySSO')}}]), a}();

var CookieHelper=function(){function a(){classCallCheck(this,a);}return createClass(a,[{key:'getCookie',value:function getCookie(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:document.cookie,c=('; '+b).split('; '+a+'=');if(2===c.length)return c.pop().split(';').shift()}},{key:'deleteCookie',value:function deleteCookie(a){document.cookie=a+'=; Domain=.sky.com; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';}}]), a}();

var determineConfig=function(){if(window.location.hostname.includes('local.bskyb'))return{authenticatorEndpoint:'https://messaging-authenticator.cf.stage-paas.bskyb.com',skyportUrl:'https://skyport-graphql-e05.cf.stage-paas.bskyb.com'};var a=window.location.hostname.match(/-(tdm|u01|e05).cf.(?:dev|stage)-paas.bskyb.com/);switch(a&&a[1]){case'tdm':return{authenticatorEndpoint:'https://messaging-authenticator-tdm.cf.stage-paas.bskyb.com',skyportUrl:'https://skyport-graphql-tdm.cf.stage-paas.bskyb.com'};case'u01':return{authenticatorEndpoint:'https://messaging-authenticator-u01.cf.stage-paas.bskyb.com',skyportUrl:'https://skyport-graphql-u01.cf.stage-paas.bskyb.com'};case'e05':return{authenticatorEndpoint:'https://messaging-authenticator.cf.stage-paas.bskyb.com',skyportUrl:'https://skyport-graphql-e05.cf.stage-paas.bskyb.com'};default:return{authenticatorEndpoint:'https://messaging-authenticator.cf.stage-paas.bskyb.com',skyportUrl:'https://skyport.sky.com'};}}; var config=determineConfig();window.livepersonDtmApi={};var dom=new DomHelper; var cookies=new CookieHelper; var auth=new Auth(cookies,config);new LivePerson(dom,auth,window.livepersonDtmApi,config);

}());
